<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>404合租守则</title>
    <style>
        body {
            background-color: #030303; color: #c0c0c0;
            font-family: "Courier New", Courier, monospace;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; margin: 0; overflow: hidden;
        }
        #intro-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 100;
            display: flex; justify-content: center; align-items: center; flex-direction: column; cursor: pointer;
        }
        #intro-screen h1 { color: #aa0000; letter-spacing: 5px; animation: fadeIn 2s forwards; }
        #intro-screen p { color: #555; animation: fadeIn 2s 1s forwards; opacity: 0; }

        #game-container {
            width: 850px; max-width: 95%; height: 85vh;
            display: flex; flex-direction: column;
            background: rgba(15, 15, 15, 0.9); border: 1px solid #222;
            box-shadow: 0 0 40px rgba(0,0,0,0.95); padding: 30px; border-radius: 5px;
            display: none;
        }

        #status-bar {
            border-bottom: 1px dashed #444; padding-bottom: 15px; margin-bottom: 20px;
            font-size: 14px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 8px;
        }
        .status-item { background: #0a0a0a; padding: 6px 12px; border: 1px solid #333; border-radius: 3px; }

        #story-area { flex-grow: 1; font-size: 18px; line-height: 1.8; overflow-y: auto; margin-bottom: 20px; padding-right: 15px; }
        #story-area::-webkit-scrollbar { width: 4px; }
        #story-area::-webkit-scrollbar-thumb { background: #555; }
        #choices-area { display: flex; flex-direction: column; gap: 12px; min-height: 160px; }

        .choice-btn {
            background-color: transparent; color: #888; border: 1px solid #333;
            padding: 12px; text-align: left; font-size: 16px; cursor: pointer;
            transition: all 0.3s ease; animation: fadeIn 0.5s forwards;
        }
        .choice-btn:hover { background-color: #1a1a1a; color: #ddd; border-color: #666; padding-left: 20px; }

        .blood { color: #a00; text-shadow: 0 0 5px #600; font-weight: bold; }
        .ghost { color: #5c8a8a; text-shadow: 0 0 5px #5c8a8a; }
        .warning { color: #cc7a00; font-weight: bold; }
        .shake { display: inline-block; animation: shake-anim 0.3s infinite; }
        @keyframes shake-anim { 0% { transform: translate(1px, 1px) rotate(0deg); } 25% { transform: translate(-1px, -1px) rotate(-1deg); } 50% { transform: translate(-2px, 0px) rotate(1deg); } 75% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -1px) rotate(0deg); } }
        .glitch { position: relative; display: inline-block; color: #fff; animation: glitch-skew 1s infinite linear alternate-reverse; }
        .glitch::before, .glitch::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .glitch::before { left: 2px; text-shadow: -1px 0 red; clip: rect(44px, 450px, 56px, 0); animation: glitch-anim 5s infinite linear alternate-reverse; }
        .glitch::after { left: -2px; text-shadow: -1px 0 blue; clip: rect(44px, 450px, 56px, 0); animation: glitch-anim2 5s infinite linear alternate-reverse; }

        .fade-in { animation: fadeIn 1.2s forwards; }
        .fade-in-slow { animation: fadeIn 3.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="intro-screen" onclick="startGame()">
        <h1>404合租守则</h1>
        <p>（点击屏幕开始。包含强烈的心理压迫，请务必佩戴耳机）</p>
    </div>

    <div id="game-container">
        <div id="status-bar">
            <div class="status-item" id="location-display">位置：未知</div>
            <div class="status-item" id="bat-display">手机电量: 15%</div>
            <div class="status-item" id="sus-display">伪装暴露度(SUS): 0%</div>
            <div class="status-item" id="san-display" class="blood">理智(SAN): 100/100</div>
        </div>
        <div id="story-area"></div>
        <div id="choices-area"></div>
    </div>

    <script>
        /* ================= 音效引擎 ================= */
        let audioCtx, windSource, windFilter, windGain;

        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const bufferSize = audioCtx.sampleRate * 2;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            windSource = audioCtx.createBufferSource(); windSource.buffer = buffer; windSource.loop = true;
            windFilter = audioCtx.createBiquadFilter(); windFilter.type = 'lowpass'; windFilter.frequency.value = 200;
            windGain = audioCtx.createGain(); windGain.gain.value = 0;
            windSource.connect(windFilter); windFilter.connect(windGain); windGain.connect(audioCtx.destination);
            windSource.start();
        }

        function setBGM(mood) {
            if (!audioCtx) return;
            const now = audioCtx.currentTime;
            if (mood === 'calm') { windFilter.frequency.linearRampToValueAtTime(250, now + 1); windGain.gain.linearRampToValueAtTime(0.4, now + 1); }
            else if (mood === 'tense') { windFilter.frequency.linearRampToValueAtTime(800, now + 1); windGain.gain.linearRampToValueAtTime(0.8, now + 1); }
            else if (mood === 'silence') { windGain.gain.linearRampToValueAtTime(0.05, now + 0.5); }
        }

        function playSFX(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'death') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(10, now + 0.6);
                gain.gain.setValueAtTime(1, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.6);
                osc.start(now); osc.stop(now + 0.6);
            } else if (type === 'heart') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(55, now);
                gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(1, now + 0.1); gain.gain.linearRampToValueAtTime(0.01, now + 0.6);
                osc.start(now); osc.stop(now + 0.6);
            } else if (type === 'click') {
                osc.type = 'square'; osc.frequency.setValueAtTime(1200, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.02);
                osc.start(now); osc.stop(now + 0.02);
            }
        }

        /* ================= 核心状态 ================= */
        let playerState = {};

        function resetGame() {
            playerState = {
                san: 100, maxSan: 100, sus: 0, bat: 15,
                location: "404室客厅", hasPhone: false, gasLeaking: false
            };
            setBGM('calm');
        }

        function startGame() {
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            initAudio(); resetGame(); goToScene('node_1');
        }

        function updateUI() {
            const sanEl = document.getElementById('san-display');
            sanEl.innerText = `理智(SAN): ${playerState.san}/${playerState.maxSan}`;
            sanEl.className = (playerState.san <= 30) ? "status-item blood shake" : "status-item blood";

            const susEl = document.getElementById('sus-display');
            susEl.innerText = `伪装暴露度(SUS): ${playerState.sus}%`;
            if(playerState.sus >= 50) { susEl.className = "status-item blood shake"; }
            else if(playerState.sus > 0) { susEl.className = "status-item warning"; }
            else { susEl.className = "status-item"; }

            const batEl = document.getElementById('bat-display');
            batEl.innerText = `手机电量: ${playerState.bat}%`;
            batEl.className = (playerState.bat <= 5) ? "status-item blood shake" : "status-item";

            document.getElementById('location-display').innerText = `位置：${playerState.location}`;
        }

        /* ================= 剧本数据库 ================= */
        const storyNodes = {
            // 【第一幕：诡异的归人】
            "node_1": {
                location: "404室客厅", bgm: "calm",
                text: `深夜 11:30，你拖着疲惫的身体回到 404 室。客厅里没有开灯，空气中弥漫着一股说不上来的腥味。<br><br>室友“林泽”的房门紧闭着。但你借着月光，看到客厅的茶几上放着一部屏幕碎裂的手机，边缘沾着干涸的暗红色污渍。<br>手机下面，压着一张字迹极其凌乱的黄色便利贴。旁边还丢着一个打火机。`,
                choices: [
                    { text: "立刻拿起碎屏手机查看", target: "node_2" },
                    { text: "先抽出那张黄色便利贴", target: "node_3" }
                ]
            },

            "node_2": {
                location: "404室客厅", bgm: "tense", sfx: "heart",
                action: () => { playerState.hasPhone = true; },
                text: `这是一部设了密码的旧手机。电量显示只有 <span class="blood shake">[15%]</span>。<br><br>防盗门外突然传来了极其沉重的脚步声，紧接着是钥匙插进锁孔的声音。林泽回来了！<br>你眼角瞥见茶几上的便利贴，写着《404室合租安全守则》。`,
                choices: [{ text: "一把抓起手机和便利贴塞进口袋！", target: "node_4_sus" }]
            },

            "node_3": {
                location: "404室客厅", bgm: "tense", sfx: "heart",
                action: () => { playerState.hasPhone = true; },
                text: `字迹抖得厉害：“守则一：11点后回来的室友，如果鞋尖朝后，立刻回房锁门。<br>守则三：如果他给你<span class="blood">红色塑料袋</span>，必须笑着收下，但绝不能吃！”<br><br>防盗门把手正在转动！你顺手抄起了便利贴和下面的手机。`,
                choices: [{ text: "装作若无其事地站在原地", target: "node_4_normal" }]
            },

            "node_4_sus": {
                location: "404室门口", bgm: "silence",
                action: () => { playerState.sus += 10; },
                text: `防盗门开了。“林泽”浑身湿漉漉的，嘴角向上咧着极其僵硬的弧度。他死死盯着你原本放手机的茶几位置看了一眼。<br><br>“你还没睡啊？”他抬起手，将一个滴着不明液体的<span class="blood">红色塑料袋</span>递给你。“顺路买的烤串，趁热……吃了吧。”`,
                choices: [
                    { text: "【笑着接过】“谢谢啊，正好饿了，我回房间吃。”", target: "node_5" },
                    { text: "【冷漠拒绝】“不用了，晚上不吃东西。”", target: "node_6" },
                    { text: "【当面拆开】“哇，谢谢室友，我尝一口。”", target: "node_7_death" }
                ]
            },

            "node_4_normal": {
                location: "404室门口", bgm: "silence",
                text: `防盗门开了。“林泽”浑身湿漉漉的，嘴角向上咧着极其僵硬的弧度。<br><br>“你还没睡啊？”他抬起手，将一个滴着不明液体的<span class="blood">红色塑料袋</span>递给你。“顺路买的烤串，趁热……吃了吧。”`,
                choices: [
                    { text: "【笑着接过】“谢谢啊，正好饿了，我回房间吃。”", target: "node_5" },
                    { text: "【冷漠拒绝】“不用了，晚上不吃东西。”", target: "node_6" },
                    { text: "【当面拆开】“哇，谢谢室友，我尝一口。”", target: "node_7_death" }
                ]
            },

            "node_5": {
                location: "次卧", bgm: "calm", slow: true,
                action: () => { playerState.sus = Math.max(0, playerState.sus - 10); },
                text: `你强忍着恶臭挤出自然的微笑。“林泽”直勾勾盯着你足足五秒，最终咧开的嘴角放了下来：“嗯，那你看剧吧。”<br>你转身走向次卧。关门的那一刻，你透过门缝看了他一眼——<b>他脱下的鞋子，鞋尖是朝向门外的。</b><br>你立刻反锁了房门。`,
                choices: [{ text: "把袋子踢进床底，拿出那部碎屏手机", target: "act_2_phone" }]
            },

            "node_6": {
                location: "404室客厅", bgm: "tense", sfx: "heart",
                action: () => { playerState.sus += 30; },
                text: `你拒绝了他。他举着袋子的手悬在半空，脸部肌肉不自然地抽搐。<br>“为什么不吃？你……是不是觉得里面有毒？”<br>他猛地向前跨了一步，死死盯着你的口袋。`,
                choices: [
                    { text: "【强装镇定】“我最近胃肠炎，闻不得油腻的。”", target: "node_5_scared" },
                    { text: "【转身就跑】直接冲回房间反锁门！", target: "node_8_death" }
                ]
            },

            "node_5_scared": {
                location: "次卧", bgm: "calm", slow: true,
                action: () => { playerState.san -= 20; },
                text: `你搬出借口，冷汗湿透了后背。他盯着你很久才放下手：“那真是……太可惜了。”<br>你跌跌撞撞退回次卧反锁房门。压力让你喘不过气。`,
                choices: [{ text: "把袋子踢进床底，拿出那部碎屏手机", target: "act_2_phone" }]
            },

            "node_7_death": {
                location: "深渊", slow: true, sfx: "death", action: () => { playerState.san = 0; playerState.sus = 100; },
                text: `袋子里是一堆蠕动的黑色肉块。但在他注视下，你像提线木偶般塞进了嘴里。<br>“好吃吗？好吃的话……<span class="blood glitch" data-text="把你也做成这样吧把你也做成这样吧">把你也做成这样吧。</span>”`,
                choices: [{ text: "【结局：被同化的食客】(重新开始)", target: "node_1", action: resetGame }]
            },

            "node_8_death": {
                location: "深渊", slow: true, sfx: "death", action: () => { playerState.san = 0; playerState.sus = 100; },
                text: `你转身狂奔，一只冰冷长满鳞片的手死死抓住了你的后脖颈。<br>“你看到了对不对？！！”<br>他裂开巨口直接咬在了你的头上。`,
                choices: [{ text: "【结局：露馅的猎物】(重新开始)", target: "node_1", action: resetGame }]
            },

            // 【第二幕：破解手机与卫生间危机】
            "act_2_phone": {
                location: "次卧", bgm: "silence",
                text: `你坐在床上，看着手里只有 15% 电量的手机。屏幕显示需要 4 位数密码。<br>你回想起之前在客厅日历上看到，今天被林泽用红笔画了个圈。`,
                choices: [
                    { text: "尝试输入 1234 (消耗 5% 电量)", target: "phone_fail" },
                    { text: "输入今天的日期 1024 (消耗 5% 电量)", target: "phone_success" }
                ]
            },

            "phone_fail": {
                location: "次卧", bgm: "silence",
                action: () => { playerState.bat -= 5; playerState.san -= 10; },
                text: `密码错误。电量下降，你的内心越发焦躁。`,
                choices: [
                    { text: "重新输入今天的日期 1024 (消耗 5% 电量)", target: "phone_success" }
                ]
            },

            "phone_success": {
                location: "次卧", bgm: "tense", sfx: "heart",
                action: () => { playerState.bat -= 5; },
                text: `密码正确！你点开微信，看到了林泽和房东的聊天记录：<br>“房东，上一任租客到底怎么死的？我总觉得这几天半夜，他在天花板上看着我……”<br><br>就在这时，客厅传来极具节奏的“咚、咚、咚”剁肉声。由于极度的紧张，你现在必须去一趟卫生间，否则理智将彻底崩溃。`,
                choices: [{ text: "深吸一口气，悄悄推开房门去卫生间", target: "bathroom_trip" }]
            },

            "bathroom_trip": {
                location: "卫生间", bgm: "calm", slow: true,
                text: `你贴着墙根溜进卫生间。余光瞥见“林泽”背对着你在厨房剁着什么，脚上的拖鞋依然是反穿的。<br><br>你反锁上卫生间的门，一抬头，发现镜子上起了厚厚的一层雾。守则二警告过：绝对不要擦拭起雾的镜子！`,
                choices: [
                    { text: "实在忍不住，伸手擦掉镜子上的雾气", target: "bathroom_death" },
                    { text: "死死低着头洗手，绝对不抬头看镜子", target: "bathroom_hide" }
                ]
            },

            "bathroom_death": {
                location: "镜中世界", slow: true, sfx: "death", action: () => { playerState.san = 0; },
                text: `你抹开了雾气。<br>镜子里的“你”并没有伸手，而是直勾勾地盯着你，嘴角咧到了耳根。<br>一双惨白的手从镜子里伸出来，把你拖了进去。<span class="blood">“来替我吧...”</span>`,
                choices: [{ text: "【结局：镜中替死鬼】(重新开始)", target: "node_1", action: resetGame }]
            },

            "bathroom_hide": {
                location: "卫生间", bgm: "tense", sfx: "heart",
                text: `你低着头疯狂洗手。突然，背后的卫生间门被重重敲响！<br>“你用完了吗？水管好像漏了，我进来修一下。”<br>门把手开始被缓缓拧动……`,
                choices: [
                    { text: "开门让他进来", target: "node_8_death" },
                    { text: "捂住嘴巴不出声装死", target: "bathroom_sus" },
                    { text: "【大喊回应】“马上就好！”同时把水龙头开到最大！", target: "bathroom_escape" }
                ]
            },

            "bathroom_sus": {
                location: "卫生间", bgm: "tense",
                action: () => { playerState.sus += 50; },
                text: `你死死捂住嘴巴。门外的敲门声变成了疯狂的撞击！<br>“我知道你在里面！开门！！”<br>门框已经开始变形了，你必须想办法脱身！`,
                dynamicChoices: () => {
                    if (playerState.sus >= 100) return [{ text: "门被撞破了...", target: "node_8_death" }];
                    return [{ text: "趁他停顿的瞬间，猛推开门冲出去！", target: "hallway_run" }];
                }
            },

            "bathroom_escape": {
                location: "卫生间", bgm: "calm",
                text: `巨大的水流声掩盖了你的恐惧。“林泽”在门外站了一会儿：“那我再去拿个扳手。”<br>沉重的脚步声走向了阳台。这是你逃回房间的唯一机会！`,
                choices: [{ text: "拉开门，冲向次卧", target: "hallway_run" }]
            },

            "hallway_run": {
                location: "客厅", bgm: "tense",
                text: `你冲出卫生间，路过厨房时，你闻到了极其浓烈的煤气味。由于之前“林泽”在剁肉，厨房的阀门似乎老化了。`,
                choices: [
                    { text: "不管那么多，直接冲回房间反锁！", target: "act_3_wifi" },
                    { text: "【兵行险招】顺手把厨房的天然气阀门彻底拧到底，然后逃回房间！", target: "act_3_wifi_gas" }
                ]
            },

            // 【第三幕：断网与终局审判】
            "act_3_wifi": {
                location: "次卧被窝", bgm: "silence", slow: true,
                text: `凌晨 3:00。家里的 Wi-Fi 突然断了。你的手机列表里弹出新信号：<span class="warning">"404_Help"</span>。<br><br>门外传来指甲抓挠木门的声音，伴随着林泽带着哭腔的哀求：“开门啊！外面有怪物！救救我让我进去！”<br>你拿出碎屏手机，电量还剩最后 5%。`,
                choices: [{ text: "点开手机里隐藏的视频备忘录 (消耗 5% 电量)", target: "final_truth" }]
            },

            "act_3_wifi_gas": {
                location: "次卧被窝", bgm: "silence", slow: true,
                action: () => { playerState.gasLeaking = true; },
                text: `你拧开了煤气阀门逃回房间。凌晨 3:00。家里的 Wi-Fi 突然断了。新信号：<span class="warning">"404_Help"</span>。<br><br>门外传来林泽带着哭腔的哀求：“开门啊！救救我让我进去！”客厅的煤气浓度估计已经爆表了。<br>你拿出碎屏手机，电量还剩最后 5%。`,
                choices: [{ text: "点开手机里隐藏的视频备忘录 (消耗 5% 电量)", target: "final_truth" }]
            },

            "final_truth": {
                location: "次卧", bgm: "tense", sfx: "heart",
                action: () => { playerState.bat = 0; },
                text: `视频里，真正的林泽躲在衣柜里录像，镜头拍向天花板——天花板上趴着一个四肢扭曲、长着林泽脸的怪物。<br>手机黑屏了。<br><br>你终于明白，门外求救的根本不是人。真正的林泽早就被吃掉替代了。《安全守则》是上一个受害者留下的！门框正在发出碎裂的哀鸣！`,
                dynamicChoices: () => {
                    let opts = [
                        { text: "心软了，开门救他", target: "node_8_death" },
                        { text: "死死捂住耳朵躲在被窝里熬到天亮", target: "end_normal" }
                    ];
                    if (playerState.gasLeaking) {
                        opts.push({ text: "【拿出打火机】点燃废纸，从门缝塞向满是煤气的客厅，然后跳窗！", target: "end_true" });
                    }
                    return opts;
                }
            },

            "end_normal": {
                location: "清晨的街道", bgm: "calm", slow: true,
                text: `【结局：苟延残喘】<br><br>你死守规则，在恐惧中熬到了天亮。趁着室友“睡觉”，你连行李都没拿夺门而逃。<br>你活了下来，但落下了严重的创伤后遗症，每晚睡觉前，总觉得床底下塞满了红色塑料袋。`,
                choices: [{ text: "重新开始", target: "node_1", action: resetGame }]
            },

            "end_true": {
                location: "废墟", bgm: "calm", slow: true,
                text: `【结局：破局者】<br><br>轰——！！！<br>剧烈的爆炸掀翻了404室的防盗门。你在千钧一发之际顺着二楼的水管滑了下去。怪物在烈火中发出了凄厉的惨叫。<br><br>你不仅终结了怪谈，还顺藤摸瓜将骗保养怪的黑心房东送进了监狱。你战胜了恐惧。`,
                choices: [{ text: "达成完美结局！再玩一次", target: "node_1", action: resetGame }]
            }
        };

        function goToScene(sceneId) {
            const scene = storyNodes[sceneId];
            if (!scene) return;

            if (scene.action) scene.action();
            if (scene.location) playerState.location = scene.location;
            if (scene.bgm) setBGM(scene.bgm);
            if (scene.sfx) playSFX(scene.sfx);

            updateUI();

            const storyEl = document.getElementById('story-area');
            storyEl.className = '';
            void storyEl.offsetWidth;
            storyEl.classList.add(scene.slow ? 'fade-in-slow' : 'fade-in');

            let sceneText = scene.text;
            if (scene.dynamicText) sceneText = scene.dynamicText();
            storyEl.innerHTML = sceneText;

            const choicesEl = document.getElementById('choices-area');
            choicesEl.innerHTML = '';
            let delayTime = scene.slow ? 3500 : 0;

            setTimeout(() => {
                let currentChoices = scene.choices || [];
                if (scene.dynamicChoices) currentChoices = scene.dynamicChoices();

                currentChoices.forEach(choice => {
                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    btn.innerText = `> ${choice.text}`;
                    btn.onclick = () => {
                        playSFX('click');
                        if (choice.action) choice.action();
                        goToScene(choice.target);
                    };
                    choicesEl.appendChild(btn);
                });
            }, delayTime);
        }
    </script>
</body>
</html>